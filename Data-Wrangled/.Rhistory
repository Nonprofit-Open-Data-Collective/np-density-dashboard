dd1 <-readRDS('f1023ez_approvals_2014.rds')
# now, replicating code provided in: https://nonprofit-open-data-collective.github.io/open-1023-ez-dataset/Step-01-ProcessRawData.html
setwd('/Volumes/My Passport for Mac/Urban Institute/Summer Projects/Geospatial Dashboard/R code for now/Data-Raw' )
dd1 <-readRDS('f1023ez_approvals_2014.rds')
dd2 <-readRDS('f1023ez_approvals_2015.rds')
dd3 <-readRDS('f1023ez_approvals_2016.rds')
dd4 <-readRDS('f1023ez_approvals_2017.rds')
dd5 <-readRDS('f1023ez_approvals_2018.rds')
dd6 <-readRDS('f1023ez_approvals_2019.rds')
dd7 <-readRDS('f1023ez_approvals_2020.rds')
dd8 <-readRDS('f1023ez_approvals_2021.rds')
colnames(dd5)[91] <- "Gamingactyno"
colnames(dd5)[92] <- "Gamingactyyes"
colnames(dd5)[103] <- "Gamingactyno.1"
colnames(dd5)[104] <- "Gamingactyyes.1"
colnames(dd6)[91] <- "Gamingactyno"
colnames(dd6)[92] <- "Gamingactyyes"
colnames(dd6)[103] <- "Gamingactyno.1"
colnames(dd6)[104] <- "Gamingactyyes.1"
colnames(dd7)[91] <- "Gamingactyno"
colnames(dd7)[92] <- "Gamingactyyes"
colnames(dd7)[103] <- "Gamingactyno.1"
colnames(dd7)[104] <- "Gamingactyyes.1"
colnames(dd8)[91] <- "Gamingactyno"
colnames(dd8)[92] <- "Gamingactyyes"
colnames(dd8)[103] <- "Gamingactyno.1"
colnames(dd8)[104] <- "Gamingactyyes.1"
# final row bind
dat <- bind_rows( dd1, dd2, dd3, dd4, dd5, dd6, dd7, dd8 )
library(tidyverse)
# final row bind
dat <- bind_rows( dd1, dd2, dd3, dd4, dd5, dd6, dd7, dd8 )
x <- dat[,c("Orgname1", "Orgname2")] #subsetting only orgnames to compare
x <- x[!is.na(x$Orgname2),] #removing NAs from Orgname2
x$Org2len <- nchar(as.character(x$Orgname2))
x <- x[order(x$Org2len, decreasing = T),]
head(x, 10)
# Merging Orgname 1 and 2 to create variable ORGNAME
dat$ORGNAME <- dat$Orgname1
x <- is.na(dat$Orgname2)
x <- dat[!x,c("Orgname1","Orgname2")]
x[1:10,]
x <- is.na(dat$Orgname2)
dat$ORGNAME[!x] <- paste0(dat$ORGNAME[!x], dat$Orgname2[!x])
x <- dat[!x,"ORGNAME"]
x[1:10,]
colnames(dat)[2] <- "Case.Number"
dat <- unique(dat)
dat <- as_tibble(dat)
# now, replicating code provided in: https://nonprofit-open-data-collective.github.io/open-1023-ez-dataset/Step-01-ProcessRawData.html
setwd('/Volumes/My Passport for Mac/Urban Institute/Summer Projects/Geospatial Dashboard/R code for now/Data-Raw' )
setwd('/Volumes/My Passport for Mac/Urban Institute/Summer Projects/Geospatial Dashboard/R code for now/Data-Wrangled' )
saveRDS( dat, "NONPROFIT-ADDRESSES-2014-2019.rds")
saveRDS( dat, "NONPROFIT-ADDRESSES-2014-2021.rds")
head(dat, 10)
keep.these <-
c( "ORGNAME","ID","Mission",
"EIN","Orgname1", "Orgname2",
"Case.Number", "Formrevision", "Eligibilityworksheet",
"Address", "City", "State", "Zip", "Zippl4",
"Accountingperiodend", "Userfeesubmitted",
"Orgurl",
"Orgtypecorp", "Orgtypeunincorp", "Orgtypetrust",
"Necessaryorgdocs", "Incorporateddate", "Incorporatedstate",
"Containslimitation", "Doesnotexpresslyempower", "Containsdissolution",
"Nteecode", "Orgpurposecharitable", "Orgpurposereligious",
"Orgpurposeeducational", "Orgpurposescientific",
"Orgpurposeliterary", "Orgpurposepublicsafety",
"Orgpurposeamateursports", "Orgpurposecrueltyprevention",
"Qualifyforexemption","Leginflno", "Leginflyes",
"Compofcrdirtrustno", "Compofcrdirtrustyes",
"Donatefundsno", "Donatefundsyes", "Conductactyoutsideusno",
"Conductactyoutsideusyes", "Financialtransofcrsno",
"Financialtransofcrsyes", "Unrelgrossincm1000moreno",
"Unrelgrossincm1000moreyes", "Gamingactyno",
"Gamingactyyes", "Disasterreliefno", "Disasterreliefyes",
"Onethirdsupportpublic", "Onethirdsupportgifts",
"Benefitofcollege", "Privatefoundation508e",
"Seekingretroreinstatement", "Seekingsec7reinstatement",
"Gamingactyno.1", "Gamingactyyes.1",
"HospitalOrChurchNo", "HospitalOrChurchYes",
"Correctnessdeclaration", "Signaturename",
"Signaturetitle", "Signaturedate",
"EZVersionNumber" )
# these will be dropped
setdiff( names(dat), keep.these )
npo <- select( dat, keep.these )
npo <- dplyr::select( dat, keep.these )
#adding YR var
x <- npo$ID
npo$YR <- substr(x, start = 4, stop = 7)
#ordering variables
npo <- npo[,c(2,1,4,68,3,5:67)]
#removing duplicates
npo <- unique(npo) #from 265,220 to 263,272
rownames(npo) <- NULL
# explore duplicates
id.count <- as.data.frame(table(npo$ID))
id.count <- id.count[order(id.count$Freq, decreasing = T),]
id.count$Var1 <- as.character(id.count$Var1)
rownames(id.count) <- NULL
names(id.count) <- c("ID", "IDdup")
head(id.count) #some IDs are repeated
#joining IDdup to the dataset
npo <- left_join(npo, id.count, by = "ID")
#subsetting those with duplicates
x <- npo$IDdup > 1
dups <- npo[x,]
dups <- dups[order(dups$IDdup, decreasing = T),c(1,69,2:68)]
dups
dups[1:6,c(1,3,7,8)]
Var <- names(dups)
Case1 <- as.character(dups[10,])
Case2 <- as.character(dups[11,])
IsitEqual <- Case1 == Case2
tb <- data_frame(Var,Case1,Case2,IsitEqual)
tb[IsitEqual %in% FALSE,]
#Adding a key variable
npo <- npo[order(npo$ID),]
npo$key <- 1:nrow(npo)
#rearranging columns
npo <- npo[,c(1,70,2:69)]
#saving
npo <- as_tibble(npo)
saveRDS( npo, "NONPROFITS-2014-2021.rds")
#first member listed in the npos
d1 <-
dat %>%
select( ID, ORGNAME, EIN, Signaturedate, Case.Number,
Ofcrdirtrust1firstname, Ofcrdirtrust1lastname,
Ofcrdirtrust1title, Ofcrdirtrust1streetaddr,
Ofcrdirtrust1city, Ofcrdirtrust1state,
Ofcrdirtrust1zip, Ofcrdirtrust1zippl4 )
#standardizing the variable names for binding
nmz <- names(d1)
nmz <- gsub( "Ofcrdirtrust[1-9]", "Ofcrdirtrust", nmz )
names( d1 ) <- nmz
#adding board member #
d1$ID <- paste0( d1$ID, "-01" )
#second member listed in the npos
d2 <-
dat %>%
select( ID, ORGNAME, EIN, Signaturedate, Case.Number,
Ofcrdirtrust2firstname, Ofcrdirtrust2lastname,
Ofcrdirtrust2title, Ofcrdirtrust2streetaddr,
Ofcrdirtrust2city, Ofcrdirtrust2state,
Ofcrdirtrust2zip, Ofcrdirtrust2zippl4 )
nmz <- names(d2)
nmz <- gsub( "Ofcrdirtrust[1-9]", "Ofcrdirtrust", nmz )
names( d2 ) <- nmz
d2$ID <- paste0( d2$ID, "-02" )
#third member listed in the npos
d3 <-
dat %>%
select( ID, ORGNAME, EIN, Signaturedate, Case.Number,
Ofcrdirtrust3firstname, Ofcrdirtrust3lastname,
Ofcrdirtrust3title, Ofcrdirtrust3streetaddr,
Ofcrdirtrust3city, Ofcrdirtrust3state,
Ofcrdirtrust3zip, Ofcrdirtrust3zippl4 )
nmz <- names(d3)
nmz <- gsub( "Ofcrdirtrust[1-9]", "Ofcrdirtrust", nmz )
names( d3 ) <- nmz
d3$ID <- paste0( d3$ID, "-03" )
#fourth member listed in the npos
d4 <-
dat %>%
select( ID, ORGNAME, EIN, Signaturedate, Case.Number,
Ofcrdirtrust4firstname, Ofcrdirtrust4lastname,
Ofcrdirtrust4title, Ofcrdirtrust4streetaddr,
Ofcrdirtrust4city, Ofcrdirtrust4state,
Ofcrdirtrust4zip, Ofcrdirtrust4zippl4 )
nmz <- names(d4)
nmz <- gsub( "Ofcrdirtrust[1-9]", "Ofcrdirtrust", nmz )
names( d4 ) <- nmz
d4$ID <- paste0( d4$ID, "-04" )
#fifth member listed in the npos
d5 <-
dat %>%
select( ID, ORGNAME, EIN, Signaturedate, Case.Number,
Ofcrdirtrust5firstname, Ofcrdirtrust5lastname,
Ofcrdirtrust5title, Ofcrdirtrust5streetaddr,
Ofcrdirtrust5city, Ofcrdirtrust5state,
Ofcrdirtrust5zip, Ofcrdirtrust5zippl4 )
nmz <- names(d5)
nmz <- gsub( "Ofcrdirtrust[1-9]", "Ofcrdirtrust", nmz )
names( d5 ) <- nmz
d5$ID <- paste0( d5$ID, "-05" )
#binding all data
ppl <- bind_rows( d1, d2, d3, d4, d5 ) #all people data as individual cases.
# identifying empty cases (NAs in all fields)
x <- is.na(ppl$Ofcrdirtrustfirstname) &
is.na(ppl$Ofcrdirtrustlastname) &
is.na(ppl$Ofcrdirtrusttitle) &
is.na(ppl$Ofcrdirtruststreetaddr) &
is.na(ppl$Ofcrdirtrustcity) &
is.na(ppl$Ofcrdirtruststate)
# removing empty cases
ppl <- ppl[!x, ]
# removing duplicated data
ppl <- unique(ppl)
rownames(ppl) <- NULL
# adding YR var
x <- ppl$ID
ppl$YR <- substr(x, start = 4, stop = 7)
pander(table(ppl$YR))
# Renaming variables to more friendly names
names(ppl)
x <- c("Firstname", "Lastname", "Title", "Address", "City", "State", "Zip", "Zippl4")
names(ppl)[6:13] <- x
names(ppl)
#arranging order
ppl <- arrange( ppl, ID ) #ordering by ID (all board members of the same org together)
install.packages("gender")
library(gender) # for estimating gender from data
#creating a unique list of first names
first.names <- unique( ppl$Firstname )
gender.codes <- gender(first.names)
gender.codes <- gender(first.names)
#selecting relevant variables
gender.codes <- select( gender.codes, name, gender, proportion_male )
gender.codes
ppl <- left_join( ppl, gender.codes, by = c("Firstname" = "name"))
x <- round(prop.table(table( ppl$gender, useNA="ifany" )),2)
table( x )
#ordering variables
nmz <- c("ID",
"ORGNAME",
"EIN",
"YR",
"Signaturedate",
"Case.Number",
"Firstname",
"Lastname",
"Title",
"Address",
"City",
"State",
"Zip",
"Zippl4",
"gender",
"proportion_male")
id.count <- as.data.frame(table(ppl$ID))
id.count <- id.count[order(id.count$Freq, decreasing = T),]
head(id.count) #some IDs are repeated
#making key variable =
names(id.count) <- c("ID", "IDdup")
id.count$ID <- as.character(id.count$ID)
#joining count
ppl <- left_join(ppl, id.count, by = "ID")
#subsetting those with duplicates
x <- ppl$IDdup > 1
dups <- ppl[x,]
names(dups)
dups <- dups[order(dups$IDdup, decreasing = T),c(1,17,2:16)]
#Given ID is not unique, we will create a key variable that is unique
#Adding a key variable
ppl <- ppl[order(ppl$ID),]
ppl$key <- 1:nrow(ppl)
#rearranging columns
ppl <- ppl[,c(1,18,2:17)]
ppl <- as_tibble(ppl)
saveRDS( ppl, "PEOPLE-2014-2021.rds" )
